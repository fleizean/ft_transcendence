{% extends 'base.html' %}

{% block title %}{{username}} Profile Settings{% endblock %}

{% block app %}
    {% include "_nav.html" %}
<div class="container-top">
    <div class="profile-settings-card">
        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-md-3">
                <nav id="profileNavbar" class="navbar navbar-expand-lg navbar-light bg-light rounded">
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#profileNavLinks"
                        aria-controls="profileNavLinks" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="profileNavLinks">
                        <ul class="navbar-nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="#editProfile"
                                    onclick="displaySection('editProfile')"><i class="bi bi-pencil-fill"></i> Edit
                                    Profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#changePassword"
                                    onclick="displaySection('changePassword')"><i class="bi bi-lock-fill"></i> Change
                                    Password</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#addSocial" onclick="displaySection('addSocial')"><i
                                        class="bi bi-bookmark-fill"></i> Add Socials</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#blockedUsers"
                                    onclick="displaySection('blockedUsers')"><i class="bi bi-ban"></i> Blocked Users</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#closeAccount"
                                    onclick="displaySection('closeAccount')"><i class="bi bi-door-closed-fill"></i>
                                    Close Account</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
            <!-- Edit Profile Content -->

            <div class="col-xl-9">
                <!-- Change Photo Section -->

                <!-- Edit Profile Form -->
                <section id="editProfile">
                        <form id="avatar_form" name="avatar_form" enctype="multipart/form-data" method="post">
                            {% csrf_token %}
                           <div class="profile-pic-container">
                                <label for="id_avatar" class="profile-pic-label">
                                    <img src="{{avatar}}" alt="Profile Picture"
                                    class="profile-pic">
                                    <div class="change-image-overlay">
                                        <span class="bi bi-image-fill"></span>
                                        <span class="change-image-text">Change Image</span>
                                    </div>
                                </label>
                                <input type="file" name="avatar" accept="image/*" id="id_avatar" class="file-input" value="{{avatar}}">
                            </div> 
                        </form>
                        <form id="profile_form" name="profile_form" enctype="multipart/form-data" method="post">
                            {% csrf_token %}
                            <!-- Username textbox -->
                            <div class="mb-3">
                                <label class="small mb-1" for="id_username">Username (how your name will appear to other
                                    users on the site)</label>
                                <input class="form-control" id="id_username" name="username" required type="text" value="{{username}}"
                                    placeholder="{{username}}">
                            </div>

                            <!-- Email textbox -->
                            <div class="mb-3">
                                <label class="small mb-1" for="id_email">Email</label>
                                <input class="form-control" id="id_email" name="email" maxlength="320" value="{{profile.email}}" required
                                    placeholder="{{profile.email}}" type="email">
                            </div>

                            <!-- Displayname textbox -->
                            <div class="mb-3">                           
                                    <label class="small mb-1" for="id_displayname">Displayname</label>
                                    <input class="form-control" id="id_displayname" name="displayname" required type="text"
                                        placeholder="{{profile.displayname}}" value="{{profile.displayname}}">
                            </div>
                            <!-- Submit button -->
                            <button type="submit" name="profile_form" class="btn btn-success">Save Changes</button>
                        </form>
                </section>


                <!-- Change Password Section -->
                <section id="changePassword">
                    <!-- Your code for changing password goes here -->
                    <form id="password_form" name="password_form" enctype="multipart/form-data" method="post">
                        {% csrf_token %}
                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_old_password">Current Password</label>
                            <div class="input-group">
                                <input class="form-control" name="old_password" id="id_old_password" type="password" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePasswordVisibility('currentPassword')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_new_password1">New Password</label>
                            <div class="input-group">
                                <input class="form-control" id="id_new_password1" name="new_password1" type="password" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePasswordVisibility('newPassword')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_new_password2">Confirm New Password</label>
                            <div class="input-group">
                                <input class="form-control" id="id_new_password2" name="new_password2" type="password" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePasswordVisibility('confirmNewPassword')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" name="password_form" class="btn btn-primary"><i class="bi bi-lock-fill"></i> Change
                            Password</button>
                    </form>
                </section>

                <section id="addSocial">
                    <form id="social_form" name="social_form" enctype="multipart/form-data" method="post" action="{% url 'profile_settings' username=request.user.username %}">
                        {% csrf_token %}
                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_stackoverflow">
                                <i class="bi bi-stack-overflow fs-4"></i> Stackoverflow
                            </label>
                            <div class="input-group">
                                <input type="text" name="stackoverflow" class="form-control" id="id_stackoverflow" 
                                    placeholder="Enter your Stackoverflow username" value="{{ profile.social.stackoverflow }}">
                            </div>
                        </div>

                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_twitter">
                                <i class="bi bi-twitter-x fs-4"></i> Twitter
                            </label>
                            <div class="input-group">
                                <input type="text" name="twitter" class="form-control" id="id_twitter" 
                                    placeholder="Enter your Twitter username" value="{{ profile.social.twitter }}">
                            </div>
                        </div>

                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_instagram">
                                <i class="bi bi-instagram fs-4"></i> Instagram
                            </label>
                            <div class="input-group">
                                <input type="text" name="instagram" class="form-control" id="id_instagram"
                                    placeholder="Enter your Instagram username" value="{{ profile.social.instagram }}">
                            </div>
                        </div>

                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_github">
                                <i class="bi bi-github fs-4"></i> Github
                            </label>
                            <div class="input-group">
                                <input type="text" name="github" class="form-control" id="id_github"
                                    placeholder="Enter your Github username" value="{{ profile.social.github }}">
                            </div>
                        </div>

                        <!-- Diğer sosyal medya platformları için benzer şekilde devam edebilirsiniz -->

                        <button type="submit" name="social_form" class="btn btn-primary"><i class="bi bi-save-fill"></i> Save
                            Changes</button>
                    </form>
                </section>

                <section id="closeAccount">
                    <form id="delete_account_form" name="delete_account_form" enctype="multipart/form-data" method="post">
                        {% csrf_token %}
                        <div class="mb-3 position-relative">
                            <label class="small mb-1" for="id_password">
                                Enter your password to delete your account:
                            </label>
                            <div class="input-group">
                                <input class="form-control" id="id_password" type="password" name="password" required>
                                <button class="btn btn-outline-danger" type="button"
                                    onclick="togglePasswordVisibility('passwordToDeleteAccount')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <p>
                            Hello, we're sorry to see you leave the IndianPong community, but we respect your decision.
                            After clicking
                            the 'Delete Account' button, you will be separated from us, so please think carefully, as
                            there will be no turning back. Anyway, see you around!
                        </p>
                        <button type="button" name="delete_account_form" class="btn btn-danger">
                            <i class="bi bi-trash-fill"></i> Delete Account
                        </button>
                    </form>
                </section>

                <section id="blockedUsers">
                    <form id="blockedUsersForm">
                        <h4>Blocked Accounts</h4>
                        <p class="blocked-users-info">Someone you block cannot follow or message you and you will not
                            receive notifications from them.</p>
                        <div class="accounts-list">
                            {% for blocked in blocked_page_obj %}
                                <div class="account">
                                    <!-- form post edileceği yer -->
                                    <div class="profile-info">
                                        <a href="/profile" data-link><img src="{{blocked.avatar}}"
                                                alt="Profile Image"></a>
                                        <div class="user-details">
                                            <a href="/profile" data-link>
                                                <h5>{{blocked.displayname}}</h5>
                                            </a>
                                            <p>{{blocked.username}}</p>
                                        </div>
                                        <button type="submit" class="btn-block">Blocked</button> <!--kişi blockladığı kişiyi çıkarmak için isim karşılığına button -->
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <nav aria-label="Page navigation example">
                                <ul class="pagination">
                                    <li class="page-item {% if blocked_page_obj.has_previous %}disabled{% endif %}">
                                        <a class="page-link" href="{% if blocked_page_obj.has_previous %}?page={{ blocked_page_obj.previous_page_number }}{% endif %}" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    {% for page_num in blocked_page_obj.paginator.page_range %}
                                        <li class="page-item {% if page_num == blocked_page_obj.number %}active{% endif %}">
                                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                        </li>
                                    {% endfor %}
                                    <li class="page-item {% if blocked_page_obj.has_next %}disabled{% endif %}">
                                        <a class="page-link" href="{% if blocked_page_obj.has_next %}?page={{ blocked_page_obj.next_page_number }}{% endif %}" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>        
                        </div>
                    </form>
                </section>
            </div>
        </div>
    </div>
</div>
<script>
function displaySection(sectionId) {
    var sections = ["editProfile", "addSocial", "closeAccount","blockedUsers", "changePassword"];

    for (var i = 0; i < sections.length; i++) {
        var section = document.getElementById(sections[i]);
        if (sections[i] === sectionId) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    }
    
   
}
window.onload = function() {
        // Get the hash from the URL
        var hash = window.location.hash;        
        // If there's a hash
        if(hash) {
            // Remove the '#' from the start of the hash
            var sectionId = hash.substring(1);
        
            // Call the displaySection function with the sectionId
            displaySection(sectionId);
        }
    }
    window.onhashchange = function() {
    var currentFragment = window.location.hash.substring(1);
    displaySection(currentFragment);
};

const fileInput = document.getElementById('id_avatar');
fileInput.addEventListener('change', function(event) {
    const form = document.getElementById('avatar_form');
    
    // Form alanına form_name değerini ekleyelim
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'avatar_form'; // Bu, form_name değeridir
    hiddenInput.value = 'avatar_form';
    form.appendChild(hiddenInput);
    
    // Formu submit et
    form.submit();
});

</script>
{% endblock %}