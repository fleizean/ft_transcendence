{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile.username }}{% endblock title %}
{% block app %}
{% include "_nav.html" %}
    <!-- "Edit Profile" ve "Match History" Navbar -->
    
<div class="profile-card">

    <div class="row">
        <!-- Sol Sütun (col-lg-4) -->
        <div class="col-lg-4 col-md-6 col-sm-12">
            <!-- Profil Kartı -->
            <div class="card mb-4" style="background-color:white !important">
                <!-- Profil Kartı içeriği -->
                {% if profile.is_indianai %}
                    <span class="pro-profile"><i class="bi bi-robot"></i> I'M JUST ROBOT</span>
                {% elif profile.rank is not None %}
                    <span class="pro-profile"><i class="bi bi-award-fill"></i> {{ profile.rank }} IN RANKINGS</span>
                {% else %}
                    <span class="pro-profile"><i class="bi bi-exclamation-diamond-fill"></i> NO RANKING</span>
                {% endif %}
                <div class="card-body text-center">
                    <!-- Avatar -->
                    {% if not profile.avatar %}
                        <img src="/static/assets/profile/profilephoto.jpeg" alt="avatar" class="profile-image-circ" style="aspect-ratio: 1/1; object-fit: cover;">
                    {% else %}
                        <img src="{{ profile.avatar.url }}" alt="avatar" class="profile-image-circ" style="aspect-ratio: 1/1; object-fit: cover;">
                    {% endif %}
                    <!-- isim -->
                    <h5 class="my-3">{{profile.username}}</h5>
                    <!-- Meslek -->
                    {% if profile.github %}
                        <p class="text-muted mb-1" style="color: orange !important;margin-top: -15px;font-size: 15px; font-weight: 600;">Software Developer</p>
                    {% endif %}
                    <div class="d-flex justify-content-center mb-2" style="margin-top: 30px;">
                        {% if request.user.username != profile.username %}
                            {% csrf_token %}
                            {% if is_friend %}
                                <button data-username="{{ profile.username }}" class="unfollow-btn" ><i class="bi bi-heartbreak-fill"></i>Unfollow</button>
                            {% else %}
                                <button data-username="{{ profile.username }}" class="btn btn-danger"><i class="bi bi-heart-fill"></i>Follow</button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Sosyal Medya ve Website Bilgileri -->
            <div class="card mb-4" style="background-color:white !important">
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush rounded-3">
                        <!-- Website -->
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <i class="bi bi-stack-overflow" style="color: orange"></i>
                            {% if profile.social.stackoverflow %}
                                <a href="https://stackoverflow.com/users/{{profile.social.stackoverflow}}" target="_blank" style="text-decoration: none;"><p class="mb-0">{{profile.social.stackoverflow}} - Stackoverflow</p></a>
                            {% else %}
                                <p class="mb-0">No Stackoverflow</p>
                            {% endif %}
                        </li>
                        <!-- GitHub -->
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <i class="bi bi-github" style="color: #333333;"></i>
                            {% if profile.social.github %}
                                <a href="https://github.com/{{profile.social.github}}" target="_blank" style="text-decoration: none;"><p class="mb-0">{{profile.social.github}} - Github</p></a>
                            {% else %}
                                <p class="mb-0">No Github</p>
                            {% endif %}
                        </li>
                        <!-- Twitter -->
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <i class="bi bi-twitter-x" style="color: #55acee;"></i>
                            {% if profile.social.twitter %}
                                <a href="https://x.com/{{profile.social.twitter}}" target="_blank" style="text-decoration: none;"><p class="mb-0">{{profile.social.twitter}} - Twitter</p></a>
                            {% else %}
                                <p class="mb-0">No Twitter</p>
                            {% endif %}
                        </li>
                        <!-- Instagram -->
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <i class="bi bi-instagram" style="color: #ac2bac;"></i>
                            {% if profile.social.instagram %}
                                <a href="https://www.instagram.com/{{profile.social.instagram}}" target="_blank" style="text-decoration: none;"><p class="mb-0">{{profile.social.instagram}} - Instagram</p></a>
                            {% else %}
                                <p class="mb-0">No Instagram</p>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Sağ Sütun (col-lg-8) -->
        <div class="col-lg-8">
            <!-- Profil Bilgileri -->
            <div class="card" style="background-color:white !important;">
                <div class="card-body">
                    <div class="match-history">
                        <table class="card-mhistory-table">
                            <thead>
                                <tr>
                                    <th>Opponent</th>
                                    <th>Result</th>
                                    <th>Score</th>
                                    <th>Duration</th>
                            </thead>
                            <tbody>
                                {% for game in history_page_obj %}
                                    <tr>
                                        {% if profile.username == game.player1.username %}
                                            <td class="mhistory-username">{{ game.player2.username }}</td>
                                        {% else %}
                                            <td class="mhistory-username">{{ game.player1.username }}</td>
                                        {% endif %}
                                        {% if profile.username == game.player1.username %}
                                            {% if game.winner.username == game.player1.username %}
                                                <td class="won">Win</td>
                                            {% else %}
                                                <td class="lose">Lost</td>
                                            {% endif %}
                                        {% else %}
                                            {% if game.winner.username == game.player2.username %}
                                                <td class="won">Win</td>
                                            {% else %}
                                                <td class="lose">Lost</td>
                                            {% endif %}
                                        {% endif %}
                                        <td>
                                            {% if profile.username == game.player1.username %}
                                                {{ game.player1_score }} - {{ game.player2_score }}
                                            {% else %}
                                                {{ game.player2_score }} - {{ game.player1_score }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ game.formatted_game_duration }}
                                        </tr>
                                {% endfor %}
                                
                            </tbody>
                        </table>
                        <nav aria-label="Page navigation example " class="mt-4">
                            <ul class="pagination justify-content-center">
                              <li class="page-item {% if not history_page_obj.has_previous %}disabled{% endif %}">
                                <a class="page-link" href="{% if history_page_obj.has_previous %}?page={{ history_page_obj.previous_page_number }}{% endif %}" aria-label="Previous">
                                  <span aria-hidden="true">&laquo;</span>
                                </a>
                              </li>
                              {% for page_num in history_page_obj.paginator.page_range %}
                                <li class="page-item {% if page_num == history_page_obj.number %}active{% endif %}">
                                  <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                </li>
                              {% endfor %}
                              <li class="page-item {% if not history_page_obj.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{% if history_page_obj.has_next %}?page={{ history_page_obj.next_page_number }}{% endif %}" aria-label="Next">
                                  <span aria-hidden="true">&raquo;</span>
                                </a>
                              </li>
                            </ul>
                          </nav>    
                    </div>
                </div>
            </div>
            <!-- Proje Durumu Kartları -->
            <div class="row">
                <!-- Sol Proje Kartı -->
                <div class="col-md-6">
                    <div class="card mb-4 mb-md-0" style="background-color:white !important; margin-top:10px">
                        <div class="card-body">
                            <!-- Proje Durumu Başlığı -->
                            <p class="mb-4"><span class="text-primary font-italic me-1">{{profile.username}} </span>/ Rank</p>
                            <div class="rank-img">
                                <img src="{% static "assets/ranks/challenger.png" %}" alt="Challenger Rank">
                            </div>
                            <div class="rank-info">
                                <h4 class="rank-h4">Challenger</h4>
                            </div>
                            <div class="rank-info">
                                <h4 class="rank-h4">{{profile.elo_point}}EP</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Sağ Proje Kartı -->
                <div class="col-md-6">
                    <div class="card mb-4 mb-md-0" style="background-color:white !important; margin-top:10px; height: 328px;">
                        <div class="card-body">
                            <!-- Proje Durumu Başlığı -->
                            <p class="mb-4"><span class="text-primary font-italic me-1">{{profile.username}} </span>/ Stats</p>
                            <div class="stats-info">
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-dice-1-fill"></i> Games Played:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.total_games_pong %} {{profile.game_stats.total_games_pong}} {% else %} 0 {% endif %}</p>
                                </div>
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-trophy-fill"></i> Wins:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.total_win_pong %} {{profile.game_stats.total_win_pong}} {% else %} 0 {% endif %}</p>
                                </div>
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-emoji-frown-fill"></i> Loses:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.total_lose_pong %} {{profile.game_stats.total_lose_pong}} {% else %} 0 {% endif %}</p>
                                </div>
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-award-fill"></i> Win Rate:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.formatted_win_rate %} {{profile.game_stats.formatted_win_rate}} {% else %} 0 {% endif %}</p>
                                </div>
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-emoji-wink-fill"></i> Win Streak:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.total_win_streak_pong %} {{profile.game_stats.total_win_streak_pong}} {% else %} 0 {% endif %}</p>
                                </div>
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-bucket-fill"></i> Lose Streak:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.total_lose_streak_pong %} {{profile.game_stats.total_lose_streak_pong}} {% else %} 0 {% endif %}</p>
                                </div>
                                <div class="stats">
                                    <p class="stats-p"><i class="bi bi-clock-fill"></i> Average Game Duration:</p>
                                    <p class="stats-result-p">{% if profile.game_stats.formatted_game_duration %} {{profile.game_stats.formatted_game_duration}} {% else %} 0 {% endif %}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const followButtons = document.querySelectorAll(".btn, .unfollow-btn");
    followButtons.forEach((button) => {
        button.addEventListener('click', (e) => {
            const username = e.target.getAttribute('data-username');
            const action = e.target.classList.contains('unfollow-btn') ? 'unfollow' : 'follow';
            fetch(`/follow_unfollow/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data['status'] === 'ok') {
                    if (action === 'follow') {
                      e.target.innerHTML = '<i class="bi bi-heartbreak-fill"></i>Unfollow';
                      e.target.classList.add('unfollow-btn');
                      e.target.classList.remove('btn', 'btn-danger');
                    } else {
                      e.target.innerHTML = '<i class="bi bi-heart-fill"></i>Follow';
                      e.target.classList.remove('unfollow-btn');
                      e.target.classList.add('btn', 'btn-danger');
                    }
                  }
            });
        });
    });
</script>
{% endblock %}